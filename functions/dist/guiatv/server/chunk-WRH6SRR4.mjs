import './polyfills.server.mjs';
import{a as S}from"./chunk-Z4AFW3XT.mjs";import{Y as A,ha as P}from"./chunk-MTFKIQB4.mjs";import{D as c,E as f,P as C,Q as b,R as v,W as m,Z as _,ba as u,g as l,l as a,r as g,z as d}from"./chunk-GKUCNG4B.mjs";var x=(()=>{let o=class o{constructor(e,t){this.httpService=e,this.tvService=t,this.postsCache$=null,this.cacheTimestamp=0,this.CACHE_DURATION=5*60*1e3,this._blogCategories=new l([]),this.blogCategories$=this._blogCategories.asObservable(),this._posts=new l([]),this.posts$=this._posts.asObservable(),this.API_URL=S.API_BLOG,this._error=new l(null),this.error$=this._error.asObservable(),this.MOCK_POSTS=[{id:0,title:{rendered:"Blog temporal - contenido no disponible"},slug:"blog-temporal-contenido-no-disponible",excerpt:{rendered:"No hemos podido cargar el blog en remoto. Aqu\xED tienes una entrada temporal."},content:{rendered:"<p>Lo sentimos, el servicio de blog no est\xE1 disponible temporalmente. Vuelve a intentarlo en unos minutos.</p>"},date:new Date().toISOString(),categories:[],categories_name:[]}]}setBlogCategories(e){this._blogCategories.next(e)}setPosts(e){if(!e){this._posts.next([]);return}let t=Array.isArray(e)?e:[e];this._posts.next(t)}getBlogCategories(){return this._blogCategories.getValue()}getPosts(){return this._posts.getValue()}setProgramsFromApi(){this.tvService.getProgramsAndChannels().subscribe(e=>{e.length===0&&this.tvService.getFromApi().subscribe(t=>{this.httpService.setProgramas(t,"today").then(()=>{this.tvService.setData(t)})})})}getAllPosts(){let e=Date.now(),t=this.getPosts();if(t.length>0&&e-this.cacheTimestamp<this.CACHE_DURATION)return a(t);if(this.postsCache$)return this.postsCache$;let i=3;return this.postsCache$=this.httpService.get(this.API_URL).pipe(C(r=>r.pipe(b((s,n)=>{let h=s+1;if(h>i)throw n;return h},0),f(s=>d(Math.pow(2,s)*1e3)))),m(r=>{this._error.next(null),this.setPosts(r),this.cacheTimestamp=e}),c(r=>{console.error("Error fetching posts:",r),this.postsCache$=null,this._error.next("No se ha podido cargar el blog. Se muestran art\xEDculos locales.");let s=this.MOCK_POSTS;return this.setPosts(s),this.cacheTimestamp=e,a(s)}),v(1)),this.postsCache$}getPostBySlug(e){return this.httpService.get(`${this.API_URL}?slug=${e}`).pipe(c(t=>(console.error("Error fetching post by slug:",t),a([]))))}getBlogCategoriesFromApi(){return this.httpService.get(`${this.API_URL}/categories`).pipe(m(e=>this.setBlogCategories(e)),c(e=>(console.error("Error fetching categories:",e),a([]))))}getRelatedPosts(e,t=3){return this.httpService.get(`${this.API_URL}?categories=${e}&per_page=${t+1}`).pipe(c(i=>(console.error("Error fetching related posts:",i),a([]))))}intiCategories(e){let t=new Map;e.forEach(r=>{r.categories_name&&Array.isArray(r.categories_name)&&r.categories_name.forEach(s=>{s.id&&!t.has(s.id)&&t.set(s.id,s)})});let i=Array.from(t.values());this.setBlogCategories(i)}filterByCategory(e){return this.posts$.pipe(g(t=>t.filter(i=>i.categories&&i.categories.includes(e))))}searchPosts(e){let t=e.toLowerCase().trim();return this.posts$.pipe(g(i=>i.filter(r=>{let s=(r.title?.rendered||"").toLowerCase(),n=(r.excerpt?.rendered||"").toLowerCase(),h=(r.content?.rendered||"").toLowerCase();return s.includes(t)||n.includes(t)||h.includes(t)})))}sortPostsByDate(e,t=!1){return[...e].sort((i,r)=>{let s=new Date(i.date).getTime(),n=new Date(r.date).getTime();return t?s-n:n-s})}clearCache(){this.postsCache$=null,this.cacheTimestamp=0}};o.\u0275fac=function(t){return new(t||o)(u(A),u(P))},o.\u0275prov=_({token:o,factory:o.\u0275fac,providedIn:"root"});let p=o;return p})();export{x as a};
